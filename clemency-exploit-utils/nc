#!/usr/bin/python
from clemency.struct import ClemencyFile
import threading

def parse_args(argv):
    import argparse
    parser = argparse.ArgumentParser(description="Netcat with nytes")
    parser.add_argument('host', help='Host')
    parser.add_argument('port', help='Port', type=int)
    return parser.parse_args(argv)

def do_read(nf):
    while 1:
        sys.stdout.write(''.join(map(chr, nf.readuntil(10, maxsize=1024))))
        sys.stdout.flush()

def main(argv):
    args = parse_args(argv)

    import socket
    s = socket.create_connection((args.host, args.port))
    f = s.makefile('rw', 0)
    nf = ClemencyFile(f)

    th = threading.Thread(target=do_read, args=(nf,))
    th.daemon = True
    th.start()

    while 1:
        res = raw_input() + '\n'
        nf.write([ord(i) for i in res])

if __name__ == '__main__':
    import sys
    exit(main(sys.argv[1:]))
